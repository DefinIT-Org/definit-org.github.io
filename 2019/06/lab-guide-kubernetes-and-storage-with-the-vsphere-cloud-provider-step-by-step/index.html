<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><title>Lab Guide - Kubernetes and Storage with the vSphere Cloud Provider - Step by Step &#183; DefinIT</title><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content="vSAN,Cloud Native,vsphere,spbm,cnp,kubernetes,ubuntu,api,"><meta property="og:title" content="Lab Guide - Kubernetes and Storage with the vSphere Cloud Provider - Step by Step  &#183; DefinIT "><meta property="og:site_name" content="DefinIT"><meta property="og:url" content="https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step/"><meta property="og:locale" content="en-gb"><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:article:published_time" content="2019-06-19T00:00:00Z"><meta property="og:article:modified_time" content="2019-06-19T00:00:00Z"><meta property="og:article:tag" content="vSAN"><meta property="og:article:tag" content="Cloud Native"><meta property="og:article:tag" content="vsphere"><meta property="og:article:tag" content="spbm"><meta property="og:article:tag" content="cnp"><meta property="og:article:tag" content="kubernetes"><meta property="og:article:tag" content="ubuntu"><meta property="og:article:tag" content="api"><meta property="og:image" content="https://www.definit.co.uk/images/logos/kubernetes.svg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@sammcgeown"><meta name=twitter:creator content="@sammcgeown"><meta name=twitter:title content="Lab Guide - Kubernetes and Storage with the vSphere Cloud Provider - Step by Step"><meta name=twitter:description content><meta name=twitter:url content="https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step/"><meta name=twitter:domain content="https://www.definit.co.uk/"><link rel=canonical href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content="#da532c"><meta name=msapplication-config content="/browserconfig.xml"><meta name=theme-color content="#ffffff"><meta name=generator content="Hugo 0.152.2"><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/js/clr-icons.min.js></script><script src=/js/custom-elements.min.js></script><script src=/js/clr-toggle-darkmode.js></script><link id=dark-mode-css disabled href=/css/clr-ui-dark.min.css rel=stylesheet type=text/css as=style><link id=light-mode-css href=/css/clr-ui.min.css rel=stylesheet type=text/css as=style><link href=/css/clr-icons.min.css rel=stylesheet><link href=/css/definit-clarity.css rel=stylesheet><link href=/css/syntax-highlighting.css rel=stylesheet><link href=/css/lightbox.min.css rel=stylesheet></head><body id=body onload='setCurrentTheme("dark")'><clr-main-container class=main-container><header class=header-6><div class=branding><a class=logo-and-title href=/><img class=clr-header-logo alt src=/images/logos/definit-logo.png>
<span class=title>&nbsp;DefinIT</span></a></div><nav class=header-nav><a class="nav-link nav-text" href=https://www.definit.co.uk/ title=Home>Home
</a><a class="nav-link nav-text" href=https://www.definit.co.uk/about/ title=About>About
</a><a class="nav-link nav-text" href=https://www.github.com/sammcgeown title=GitHub>GitHub
</a><a class="nav-link nav-text" href=https://www.definit.co.uk/index.xml title=RSS>RSS</a></nav><div class=header-actions><form class=search id=search method=get action=//google.com/search><label for=search_input><input id=search_input type=text name=q placeholder="Search with Google">
<input type=hidden name=as_sitesearch value=https://www.definit.co.uk/></label></form><a class="nav-link nav-icon" aria-label=theme onclick=toggleThemeMode()><clr-icon shape=moon id=icon-theme-mode title="Toggle theme mode"></clr-icon></a></div></header><div class=content-container><div class=content-area><h1>Lab Guide - Kubernetes and Storage with the vSphere Cloud Provider - Step by Step</h1><div class=metas><span class=clr-card-authors><div class=clr-card-authors><img src=/images/SamMcGeown2020.jpg alt class=img-author>Written by <a href=https://www.definit.co.uk/authors/sam-mcgeown/>Sam McGeown</a></div><div class=clr-card-authors>Published on 19/6/2019 -
Read in about 7 min (1483 words)</div><div class=clr-card-authors>Published under
<a href=/category/vmware>VMware</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/vsan>#vSAN</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/cloud-native>#Cloud Native</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/vsphere>#vsphere</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/spbm>#spbm</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/cnp>#cnp</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/kubernetes>#kubernetes</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/ubuntu>#ubuntu</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/api>#api</a></div></span></div><br clear=all><div class="alert alert-danger" role=alert><div class=alert-items><div class="alert-item static"><div class=alert-icon-wrapper><clr-icon class=alert-icon shape=warning-standard></clr-icon></div><span class=alert-text>This article is now 6 years old! It is highly likely that this information is out of date and the author will have completely forgotten about it. Please take care when following any guidance to ensure you have up-to-date recommendations.</span></div></div></div><img src=/images/logos/kubernetes.svg class=clr-post-featured-image><p>Following on from me recent post <a href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/ target=_blank><clr-icon shape=pop-out size=12></clr-icon>deploying Kubernetes with the NSX-T
CNP
</a>,
I wanted to extend my environment to make use of the <a href=https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/index.html target=_blank><clr-icon shape=pop-out size=12></clr-icon>vSphere Cloud
Provider
</a>to enable Persistent Volumes backed by vSphere storage. This allows me to use
Storage Policy to create Persistent Volumes based on policy. For example, I’m
going to create two classes of storage, <em>Fast</em> and <em>Slow</em> - <em>Fast</em> will be vSAN
based and <em>Slow</em> will be NFS based.</p><p>I highly recommend you <a href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/ target=_blank><clr-icon shape=pop-out size=12></clr-icon>review the previous
post
</a>in order to familiarise yourself with the environment.</p><p>As always, I’m doing this in my lab as a learning exercise, and blogging it as a
way of making sure I understand what I’m doing! I often stand on the shoulders
of others, and in this case it is <a href=https://twitter.com/@mylesagray target=_blank><clr-icon shape=pop-out size=12></clr-icon>Myles Gray
</a>who deserves most of the credit. Again I am lucky to be able to poke Myles on
our corporate slack, but you can also check out his <a href=https://blah.cloud/kubernetes/creating-an-ubuntu-18-04-lts-cloud-image-for-cloning-on-vmware/ target=_blank><clr-icon shape=pop-out size=12></clr-icon>Kubernetes on
vSphere
</a>series which was immensely helpful.</p><h1 id=vm-pre-requisites>VM Pre-requisites <a class=anchor href=#vm-pre-requisites><i class="fas fa-hashtag"></i></a></h1><p>All the Kubernetes Node VMs need to be placed in a VM folder that’s used to
identify them. I’ve created folder <code>/kubernetes/k8s-01</code> to reflect the name of
the Kubernetes cluster</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/ByZIHT.png data-lightbox=index.images/ByZIHT.png data-title class=lb><img class=lb src=index.images/ByZIHT.png alt></a></div><p>In addition, the Kubernetes Node VMs need to have an advanced setting configured
<code>disk.EnableUUID=1</code>. You can configure this in the vSphere Web Client, or via
PowerCLI/govc. The VMs need to be shut down for the change to take effect. The
<a href=https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/prerequisites.html target=_blank><clr-icon shape=pop-out size=12></clr-icon>vSphere Cloud
Provider
</a>docs say:</p><blockquote><p>This step is necessary so that the VMDK always presents a consistent UUID to
the VM, thus allowing the disk to be mounted properly.</p></blockquote><br clear=none><div class=clr-content-image-wrap><a href=index.images/Y7qw99.png data-lightbox=index.images/Y7qw99.png data-title class=lb><img class=lb src=index.images/Y7qw99.png alt></a></div><h1 id=create-roles-and-service-account>Create Roles and Service Account <a class=anchor href=#create-roles-and-service-account><i class="fas fa-hashtag"></i></a></h1><h3 id=create-the-required-roles>Create the required Roles <a class=anchor href=#create-the-required-roles><i class="fas fa-hashtag"></i></a></h3><p>The <a href=https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/vcp-roles.html#dynamic-provisioning target=_blank><clr-icon shape=pop-out size=12></clr-icon>roles and permissions required for dynamic provisioning can be found
here
</a>.</p><table><thead><tr><th>Roles</th><th>Privileges</th><th>Entities</th><th>Propagate to Children</th></tr></thead><tbody><tr><td>vcp-manage-k8s-node-vms</td><td>Resource.AssignVMToPoolVirtualMachine.Config.AddExistingDisk, VirtualMachine.Config.AddNewDisk, VirtualMachine.Config.AddRemoveDevice, VirtualMachine.Config.RemoveDisk, VirtualMachine.Config.SettingsVirtualMachine.Inventory.Create, VirtualMachine.Inventory.Delete</td><td>Cluster, Hosts, VM Folder</td><td>Yes</td></tr><tr><td>vcp-manage-k8s-volumes</td><td>Datastore.AllocateSpace, Datastore.FileManagement (Low level file operations)</td><td>Datastore</td><td>No</td></tr><tr><td>vcp-view-k8s-spbm-profile</td><td>StorageProfile.View (Profile-driven storage view)</td><td>vCenter</td><td>No</td></tr><tr><td>Read-only (pre-existing default role)</td><td>System.Anonymous, System.Read, System.View</td><td>Datacenter, Datastore Cluster, Datastore Storage Folder</td><td>No</td></tr></tbody></table><ul><li>Navigate in the vSphere Client - Menu > Administration > Roles</li><li>Add a new Role and select the permissions required. Repeat for each role.</li></ul><br clear=none><div class=clr-content-image-wrap><figure><a href=index.images/vxVhZv.png data-lightbox=index.images/vxVhZv.png data-title="vSphere Roles" class=lb><img class=lb src=index.images/vxVhZv.png alt="vSphere Roles"></a><figcaption class=clr-caption>vSphere Roles</figcaption></figure></div><h3 id=create-a-service-account>Create a service account <a class=anchor href=#create-a-service-account><i class="fas fa-hashtag"></i></a></h3><p>Create a vsphere.local user, or add a domain user, to provide access and assign
the new roles to.</p><ul><li><a href=mailto:vcp-k8s-svc@vsphere.local>vcp-k8s-svc@vsphere.local</a></li><li>VMware1!</li></ul><h3 id=configure-account-roles-and-permissions>Configure account roles and permissions <a class=anchor href=#configure-account-roles-and-permissions><i class="fas fa-hashtag"></i></a></h3><p>Assign the role <em>vcp-manage-k8s-node-vms</em> to the <em>vcp-k8s-svc</em> account on the
Cluster and VM folder in which your Kubernetes nodes run, ensure the “Propagate
to children” is ticked.</p><br clear=none><div class=clr-content-image-wrap><figure><a href=index.images/r5UpjF.png data-lightbox=index.images/r5UpjF.png data-title="Cluster Role" class=lb><img class=lb src=index.images/r5UpjF.png alt="Cluster Role"></a><figcaption class=clr-caption>Cluster Role</figcaption></figure></div><br clear=none><div class=clr-content-image-wrap><a href=index.images/rp0vj3.png data-lightbox=index.images/rp0vj3.png data-title class=lb><img class=lb src=index.images/rp0vj3.png alt></a></div><p>Since I’ll be using two different storage policies, I’ve added the
<em>vcp-manage-k8s-volumes</em> to both the vSAN and NFS datastores.</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/N0TWkM.png data-lightbox=index.images/N0TWkM.png data-title class=lb><img class=lb src=index.images/N0TWkM.png alt></a></div><br clear=none><div class=clr-content-image-wrap><a href=index.images/eEZ5KJ.png data-lightbox=index.images/eEZ5KJ.png data-title class=lb><img class=lb src=index.images/eEZ5KJ.png alt></a></div><p>Configure the <em>vcp-view-k8s-spbm-profile</em> role on the vCenter object</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/65jaBJ.png data-lightbox=index.images/65jaBJ.png data-title class=lb><img class=lb src=index.images/65jaBJ.png alt></a></div><p>Finally, add the Read-only role to the Datacenter (and any Datastore Cluster or
Datastore Folder, if you have them).</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/FnJjLi.png data-lightbox=index.images/FnJjLi.png data-title class=lb><img class=lb src=index.images/FnJjLi.png alt></a></div><h1 id=create-a-kubernetes-secret>Create a Kubernetes Secret <a class=anchor href=#create-a-kubernetes-secret><i class="fas fa-hashtag"></i></a></h1><p>To secure the vSphere credentials they can be stored as a <a href=https://kubernetes.io/docs/concepts/configuration/secret/ target=_blank><clr-icon shape=pop-out size=12></clr-icon>Kubernetes
Secret
</a>. First,
covert the credentials to base64:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s1>&#39;vcp-k8s-svc@vsphere.local&#39;</span> <span class=p>|</span> base64
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s1>&#39;VMware1!&#39;</span> <span class=p>|</span> base64
</span></span></code></pre></td></tr></table></div></div><p>Create vcp-credentials.yaml with the base64 encoded credentials</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>vcp-vcenter</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>vcsa.definit.local.username</span><span class=p>:</span><span class=w> </span><span class=l>dmNwLWs4cy1zdmNAdnNwaGVyZS5sb2NhbA==</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=nt>vcsa.definit.local.password</span><span class=p>:</span><span class=w> </span><span class=l>Vk13YXJlMSE=</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Create the secret using kubectl in the kube-system namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f vcp-credentials.yaml --namespace<span class=o>=</span>kube-system
</span></span></code></pre></td></tr></table></div></div><p>Validate the secret is visible, but not the passwords</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe secret vcp-vcenter --namespace<span class=o>=</span>kube-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:         vcp-vcenter
</span></span><span class=line><span class=cl>Namespace:    kube-system
</span></span><span class=line><span class=cl>Labels:       &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:  &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Type:  Opaque
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>Data</span>
</span></span><span class=line><span class=cl><span class=o>====</span>
</span></span><span class=line><span class=cl>vcsa.definit.local.password:  <span class=m>8</span> bytes
</span></span><span class=line><span class=cl>vcsa.definit.local.username:  <span class=m>25</span> bytes
</span></span></code></pre></td></tr></table></div></div><p>#Configuring the Kubernetes vSphere Cloud Provider
##On the Kubernetes Master node</p><h3 id=create-vsphereconf>Create vsphere.conf <a class=anchor href=#create-vsphereconf><i class="fas fa-hashtag"></i></a></h3><p>Create the vSphere configuration file in /etc/kubernetes/vcp/vsphere.conf -
you’ll need to create the folder.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=o>[</span>Global<span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=c1># Global settings are defaults for all VirtualCenters defined below</span>
</span></span><span class=line><span class=cl>        secret-name <span class=o>=</span> <span class=s2>&#34;vcp-vcenter&#34;</span>
</span></span><span class=line><span class=cl>        secret-namespace <span class=o>=</span> <span class=s2>&#34;kube-system&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>port</span> <span class=o>=</span> <span class=s2>&#34;443&#34;</span>
</span></span><span class=line><span class=cl>        insecure-flag <span class=o>=</span> <span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>VirtualCenter <span class=s2>&#34;vcsa.definit.local&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl>        <span class=nv>datacenters</span> <span class=o>=</span> <span class=s2>&#34;DefinIT&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Workspace<span class=o>]</span> <span class=c1># Defines </span>
</span></span><span class=line><span class=cl>        <span class=nv>server</span> <span class=o>=</span> <span class=s2>&#34;vcsa.definit.local&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>datacenter</span> <span class=o>=</span> <span class=s2>&#34;DefinIT&#34;</span>
</span></span><span class=line><span class=cl>        default-datastore <span class=o>=</span> <span class=s2>&#34;SYN-NFS-01&#34;</span>
</span></span><span class=line><span class=cl>        resourcepool-path <span class=o>=</span> <span class=s2>&#34;Cluster02/Resources&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nv>folder</span> <span class=o>=</span> <span class=s2>&#34;kubernetes/k8s-01&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>[</span>Disk<span class=o>]</span>  <span class=c1># Required...</span>
</span></span><span class=line><span class=cl>        <span class=nv>scsicontrollertype</span> <span class=o>=</span> pvscsi
</span></span></code></pre></td></tr></table></div></div><h3 id=modify-the-kubelet-service>Modify the kubelet service <a class=anchor href=#modify-the-kubelet-service><i class="fas fa-hashtag"></i></a></h3><p>The vSphere Storage for Kubernetes docs are a little out of date on this - you
don’t modify the systemd unit file directly (which is likely to be overwritten
in upgrades). Instead there’s an environment file referenced in the</p><p>Append the <code>--cloud-provider</code> and <code>--cloud-config</code> flags to
<code>/var/lib/kubelet/kubeadm-flags.env</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBELET_KUBEADM_ARGS</span><span class=o>=</span>--cgroup-driver<span class=o>=</span>cgroupfs --network-plugin<span class=o>=</span>cni --pod-infra-container-image<span class=o>=</span>k8s.gcr.io/pause:3.1 --cloud-provider<span class=o>=</span>vsphere --cloud-config<span class=o>=</span>/etc/kubernetes/vcp/vsphere.conf
</span></span></code></pre></td></tr></table></div></div><h3 id=modify-container-manifests>Modify container manifests <a class=anchor href=#modify-container-manifests><i class="fas fa-hashtag"></i></a></h3><p>The container manifests for the Kubernetes API server and controller also need
to be updated with the <code>--cloud-provider</code> and <code>--cloud-config</code> flags. These are
located in the <code>/etc/kubernetes/manifests</code> folder.</p><p>Add the following to the <code>spec:containers:command</code> array, paying attention to
whitespace (it is yaml, after all!)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    - --cloud-provider<span class=o>=</span>vsphere
</span></span><span class=line><span class=cl>    - --cloud-config<span class=o>=</span>/etc/kubernetes/vcp/vsphere.conf
</span></span></code></pre></td></tr></table></div></div><p>We also need add a mount for the vsphere.conf file location in
<code>spec:containers:volumeMounts</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>    - mountPath: /etc/kubernetes/vcp
</span></span><span class=line><span class=cl>      name: vcp
</span></span><span class=line><span class=cl>      readOnly: <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><p>And a volume in <code>spec:volumes</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>  - hostPath:
</span></span><span class=line><span class=cl>      path: /etc/kubernetes/vcp
</span></span><span class=line><span class=cl>      type: DirectoryOrCreate
</span></span><span class=line><span class=cl>    name: vcp
</span></span></code></pre></td></tr></table></div></div><h2 id=on-the-kubernetes-worker-nodes>On the Kubernetes Worker nodes <a class=anchor href=#on-the-kubernetes-worker-nodes><i class="fas fa-hashtag"></i></a></h2><h3 id=modify-the-kubelet-service-1>Modify the kubelet service <a class=anchor href=#modify-the-kubelet-service-1><i class="fas fa-hashtag"></i></a></h3><p>Append the <code>--cloud-provider</code> flag to <code>/var/lib/kubelet/kubeadm-flags.env</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBELET_KUBEADM_ARGS</span><span class=o>=</span>--cgroup-driver<span class=o>=</span>cgroupfs --network-plugin<span class=o>=</span>cni --pod-infra-container-image<span class=o>=</span>k8s.gcr.io/pause:3.1 --cloud-provider<span class=o>=</span>vsphere
</span></span></code></pre></td></tr></table></div></div><h2 id=update-the-node-provide-ids>Update the Node Provide IDs <a class=anchor href=#update-the-node-provide-ids><i class="fas fa-hashtag"></i></a></h2><p>Each Kubernetes node will need a *providerId *set so that the the created
volumes are mounted to the correct node. The manual method for doing this is to
look up the VM’s UUID in vSphere, then patch the node configuration with
<code>kubectl</code> with the providerId spec. You can check if the providerId is set by
running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get nodes -o json <span class=p>|</span> jq <span class=s1>&#39;.items[]|[.metadata.name, .spec.providerID, .status.nodeInfo.systemUUID]&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p>If the output contains <em>null</em> for the providerId, then you need to set it:</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/ZjeQay.png data-lightbox=index.images/ZjeQay.png data-title class=lb><img class=lb src=index.images/ZjeQay.png alt></a></div><p>Fortunately the documentation provides a <a href=https://vmware.github.io/vsphere-storage-for-kubernetes/documentation/existing.html#update-all-node-providerid-fields target=_blank><clr-icon shape=pop-out size=12></clr-icon>hand
script
</a>for doing so, it just needs <em>govc</em>, <em>jq</em> and <em>kubectl</em> configured on each
machine. If you’re running on macOS like me, you can use homebrew to install
what you need.</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/XuCJ5P.png data-lightbox=index.images/XuCJ5P.png data-title class=lb><img class=lb src=index.images/XuCJ5P.png alt></a></div><h2 id=consuming-vsphere-storage>Consuming vSphere Storage <a class=anchor href=#consuming-vsphere-storage><i class="fas fa-hashtag"></i></a></h2><h3 id=create-storage-class>Create Storage Class <a class=anchor href=#create-storage-class><i class="fas fa-hashtag"></i></a></h3><p>To consume the new storage provider, we need to create some storage classes.
I’ve got two vSphere Storage Policies configured - one for vSAN “<em>One-node vSAN
Policy</em>", and one for NFS “<em>NFS-Storage</em>". The vSAN policy is the default policy
for my vSAN provider on the host the nodes run on, and the NFS policy is a
tag-based policy that will allow placement on any datastore tagged with the
“NFS” tag.</p><p>To use these policies I’m creating two storage classes - *fast *for vSAN:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># sc-vsan-policy.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fast</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/vsphere-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storagePolicyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;One-node vSAN Policy&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>datastore</span><span class=p>:</span><span class=w> </span><span class=l>Cluster02-vSAN</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And <em>slow</em>, for NFS:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># sc-nfs-policy.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>slow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/vsphere-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>diskformat</span><span class=p>:</span><span class=w> </span><span class=l>thin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storagePolicyName</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NFS-Storage&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>The policies are imported using the <code>kubectl apply -f sc-vsan-policy.yaml</code>
command, and we can check the policy is created by using the <code>kubectl describe storageclaim fast</code> command.</p><h3 id=create-a-persistent-volume-claim>Create a Persistent Volume Claim <a class=anchor href=#create-a-persistent-volume-claim><i class="fas fa-hashtag"></i></a></h3><p>To be able to consume the Storage Class we need to create a persistent volume
claim, or pvc, that uses the storage class:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pvc-vsan.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc-vsan</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume.beta.kubernetes.io/storage-class</span><span class=p>:</span><span class=w> </span><span class=l>fast</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># pvc-nfs.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pvc-nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volume.beta.kubernetes.io/storage-class</span><span class=p>:</span><span class=w> </span><span class=l>slow</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Again, these can be imported using the kubectl apply command, and examined with
the kubectl describe command</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl create -f pvc-vsan.yaml
</span></span><span class=line><span class=cl>kubectl create -f pvc-nfs.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl describe pvc
</span></span><span class=line><span class=cl>Name:          pvc-nfs
</span></span><span class=line><span class=cl>Namespace:     default
</span></span><span class=line><span class=cl>StorageClass:  slow
</span></span><span class=line><span class=cl>Status:        Bound
</span></span><span class=line><span class=cl>Volume:        pvc-3d6ac709-92af-11e9-ba0c-0050568aec2b
</span></span><span class=line><span class=cl>Labels:        &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:   pv.kubernetes.io/bind-completed: yes
</span></span><span class=line><span class=cl>               pv.kubernetes.io/bound-by-controller: yes
</span></span><span class=line><span class=cl>               volume.beta.kubernetes.io/storage-class: slow
</span></span><span class=line><span class=cl>               volume.beta.kubernetes.io/storage-provisioner: kubernetes.io/vsphere-volume
</span></span><span class=line><span class=cl>Finalizers:    <span class=o>[</span>kubernetes.io/pvc-protection<span class=o>]</span>
</span></span><span class=line><span class=cl>Capacity:      2Gi
</span></span><span class=line><span class=cl>Access Modes:  RWO
</span></span><span class=line><span class=cl>VolumeMode:    Filesystem
</span></span><span class=line><span class=cl>Events:
</span></span><span class=line><span class=cl>  Type       Reason                 Age                 From                         Message
</span></span><span class=line><span class=cl>  ----       ------                 ----                ----                         -------
</span></span><span class=line><span class=cl>  Normal     ProvisioningSucceeded  22s                 persistentvolume-controller  Successfully provisioned volume pvc-3d6ac709-92af-11e9-ba0c-0050568aec2b using kubernetes.io/vsphere-volume
</span></span><span class=line><span class=cl>Mounted By:  &lt;none&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Name:          pvc-vsan
</span></span><span class=line><span class=cl>Namespace:     default
</span></span><span class=line><span class=cl>StorageClass:  fast
</span></span><span class=line><span class=cl>Status:        Bound
</span></span><span class=line><span class=cl>Volume:        pvc-3f3363ee-92af-11e9-ba0c-0050568aec2b
</span></span><span class=line><span class=cl>Labels:        &lt;none&gt;
</span></span><span class=line><span class=cl>Annotations:   pv.kubernetes.io/bind-completed: yes
</span></span><span class=line><span class=cl>               pv.kubernetes.io/bound-by-controller: yes
</span></span><span class=line><span class=cl>               volume.beta.kubernetes.io/storage-class: fast
</span></span><span class=line><span class=cl>               volume.beta.kubernetes.io/storage-provisioner: kubernetes.io/vsphere-volume
</span></span><span class=line><span class=cl>Finalizers:    <span class=o>[</span>kubernetes.io/pvc-protection<span class=o>]</span>
</span></span><span class=line><span class=cl>Capacity:      2Gi
</span></span><span class=line><span class=cl>Access Modes:  RWO
</span></span><span class=line><span class=cl>VolumeMode:    Filesystem
</span></span><span class=line><span class=cl>Events:
</span></span><span class=line><span class=cl>  Type       Reason                 Age                 From                         Message
</span></span><span class=line><span class=cl>  ----       ------                 ----                ----                         -------
</span></span><span class=line><span class=cl>  Normal     ProvisioningSucceeded  19s                 persistentvolume-controller  Successfully provisioned volume pvc-3f3363ee-92af-11e9-ba0c-0050568aec2b using kubernetes.io/vsphere-volume
</span></span><span class=line><span class=cl>Mounted By:  &lt;none&gt;
</span></span></code></pre></td></tr></table></div></div><p>All being well, you should see some events initiated by the service account:</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/0jOFHS.png data-lightbox=index.images/0jOFHS.png data-title class=lb><img class=lb src=index.images/0jOFHS.png alt></a></div><p>And if you check in the configured datastores, there should now be a <em>kubevols</em>
folder and the disk provisioned by the pvc - vSAN:</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/O8ifAg.png data-lightbox=index.images/O8ifAg.png data-title class=lb><img class=lb src=index.images/O8ifAg.png alt></a></div><p>And NFS</p><br clear=none><div class=clr-content-image-wrap><a href=index.images/qG6DaE.png data-lightbox=index.images/qG6DaE.png data-title class=lb><img class=lb src=index.images/qG6DaE.png alt></a></div><p>At this point, you can consume the persistent volumes as you do for any pod.</p><h6>Share this post</h6><span class=share-box><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" onclick='return window.open(this.href,"mywin","left=20,top=20,width=500,height=500,toolbar=1,resizable=0"),!1'><i class="fa fa-facebook-official"></i></a>
<a href="https://twitter.com/intent/tweet?text=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" onclick='return window.open(this.href,"mywin","left=20,top=20,width=500,height=500,toolbar=1,resizable=0"),!1'><i class="fa fa-twitter"></i></a>
<a href="https://plus.google.com/share?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" onclick='return window.open(this.href,"mywin","left=20,top=20,width=500,height=500,toolbar=1,resizable=0"),!1'><i class="fa fa-google-plus"></i></a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" onclick='return window.open(this.href,"mywin","left=20,top=20,width=900,height=500,toolbar=1,resizable=0"),!1'><i class="fa fa-reddit"></i></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f&amp;title=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step" onclick='return window.open(this.href,"mywin","left=20,top=20,width=500,height=500,toolbar=1,resizable=0"),!1'><i class="fa fa-linkedin"></i></a>
<a href="mailto:?subject=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;body=Check out this site https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" data-proofer-ignore><i class="fa fa-envelope"></i></a>
</span><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.tumblr.com/widgets/share/tool?posttype=link&amp;title=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;caption=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;content=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f&amp;canonicalUrl=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f&amp;shareSource=tumblr_share_button" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M13.5.5v5h5v4h-5V15c0 5 3.5 4.4 6 2.8v4.4c-6.7 3.2-12 0-12-4.2V9.5h-3V6.7c1-.3 2.2-.7 3-1.3.5-.5 1-1.2 1.4-2 .3-.7.6-1.7.7-3h3.8z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f&amp;title=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;summary=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;source=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6.0 2.5 1 2.6 2.5.0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f&amp;resubmit=true&amp;title=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;body=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_self rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step%20https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=Lab%20Guide%20-%20Kubernetes%20and%20Storage%20with%20the%20vSphere%20Cloud%20Provider%20-%20Step%20by%20Step&amp;url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64.0 9.508.0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102.0 001.75.527l2.96-2.41a.405.405.0 01.494-.013l5.34 3.87a1.1 1.1.0 001.046.135 1.1 1.1.0 00.682-.803l3.91-18.795A1.102 1.102.0 0022.5.075L.706 8.475z"/></svg></div></div></a><div class="clarity-prev-next col-xs-12 col-sm-12 col-md-12 col-lg-12"><nav class=clarity-page-prev-next><div class=clr-nav-previous><a href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/ title="Lab Guide - Kubernetes and NSX-T Container Network Plugin - Step by Step" class="btn btn-sm btn-outline">Previous</a></div><div class=clr-nav-next><a href=https://www.definit.co.uk/2019/07/vmware-cloud-foundation-deployment-observations/ title="VMware Cloud Foundation - Deployment Observations" class="btn btn-sm btn-outline">Next</a></div></nav></div></div><clr-vertical-nav class="clr-vertical-nav has-nav-groups"><div class=nav-content><section class=sidenav-content><clr-vertical-nav-group class=nav-group><div class=nav-group-content><button type=button class=nav-group-trigger aria-expanded=false aria-label="Toggle vertical navigation group" onclick='toggleNavigation("categories")'><div class=nav-group-text>Categories</div><clr-icon shape=angle class=nav-group-trigger-icon id=icon-categories dir=down title=Collapse></clr-icon></button></div><div id=section-categories class=nav-group-children><clr-vertical-nav-group-children><a class=nav-link href=https://www.definit.co.uk/category/career/><span class=nav-text>career <span class="badge badge-1">28</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/cloud-native/><span class=nav-text>cloud-native <span class="badge badge-1">17</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/community/><span class=nav-text>community <span class="badge badge-1">46</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/microsoft/><span class=nav-text>microsoft <span class="badge badge-1">60</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/networking/><span class=nav-text>networking <span class="badge badge-1">29</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/nsx/><span class=nav-text>nsx <span class="badge badge-1">16</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vcf/><span class=nav-text>vcf <span class="badge badge-1">2</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vmware/><span class=nav-text>vmware <span class="badge badge-1">206</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vmware-aria/><span class=nav-text>vmware aria <span class="badge badge-1">1</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vmware-multi-cloud/><span class=nav-text>vmware multi-cloud <span class="badge badge-1">1</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vrealize-automation/><span class=nav-text>vrealize automation <span class="badge badge-1">40</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vrealize-operations/><span class=nav-text>vrealize operations <span class="badge badge-1">71</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vrealize-orchestrator/><span class=nav-text>vrealize orchestrator <span class="badge badge-1">23</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/category/vsphere/><span class=nav-text>vsphere <span class="badge badge-1">56</span></span></a></clr-vertical-nav-group-children></div></clr-vertical-nav-group><div class=nav-divider></div><clr-vertical-nav-group class=nav-group><div class=nav-group-content><button type=button class=nav-group-trigger aria-expanded=false aria-label="Toggle vertical navigation group" onclick='toggleNavigation("tags")'><div class=nav-group-text>Tags (Top 10)</div><clr-icon shape=angle class=nav-group-trigger-icon id=icon-tags dir=down title=Collapse></clr-icon></button></div><div id=section-tags class=nav-group-children><clr-vertical-nav-group-children><a class=nav-link href=https://www.definit.co.uk/tag/vrops/><span class=nav-text>vrops <span class="badge badge-1">68</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/vmware/><span class=nav-text>vmware <span class="badge badge-1">57</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/nsx/><span class=nav-text>nsx <span class="badge badge-1">41</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/automation/><span class=nav-text>automation <span class="badge badge-1">40</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/windows/><span class=nav-text>windows <span class="badge badge-1">38</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/vmworld/><span class=nav-text>vmworld <span class="badge badge-1">34</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/esx-and-esxi/><span class=nav-text>esx and esxi <span class="badge badge-1">33</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/vcenter-server/><span class=nav-text>vcenter server <span class="badge badge-1">33</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/vra/><span class=nav-text>vra <span class="badge badge-1">30</span></span>
</a><a class=nav-link href=https://www.definit.co.uk/tag/webinar/><span class=nav-text>webinar <span class="badge badge-1">29</span></span></a></clr-vertical-nav-group-children></div></clr-vertical-nav-group><div class=nav-divider></div></section></div></clr-vertical-nav><script lang=javascript>function toggleNavigation(e){var t=document.getElementById("section-"+e),n=document.getElementById("icon-"+e);t.style.display==="none"?(t.style.display="block",n.dir="down"):(t.style.display="none",n.dir="right")}</script></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-4368767-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-4368767-1")</script><script src=/js/lightbox-plus-jquery.min.js></script></clr-main-container></body></html>