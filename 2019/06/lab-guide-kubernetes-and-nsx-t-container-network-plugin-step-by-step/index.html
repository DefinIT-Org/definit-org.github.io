<!doctype html><!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]--><!--[if IE 7]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if IE 8]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class=no-js><!--<![endif]--><head><meta charset=utf-8><title>Lab Guide - Kubernetes and NSX-T Container Network Plugin - Step by Step &#183; DefinIT</title><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content="nsx,cnp,kubernetes,ubuntu,api,"><meta property="og:title" content="Lab Guide - Kubernetes and NSX-T Container Network Plugin - Step by Step  &#183; DefinIT "><meta property="og:site_name" content="DefinIT"><meta property="og:url" content="https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/"><meta property="og:locale" content="en-gb"><meta property="og:type" content="article"><meta property="og:description" content><meta property="og:article:published_time" content="2019-06-12T00:00:00Z"><meta property="og:article:modified_time" content="2019-06-12T00:00:00Z"><meta property="og:article:tag" content="nsx"><meta property="og:article:tag" content="cnp"><meta property="og:article:tag" content="kubernetes"><meta property="og:article:tag" content="ubuntu"><meta property="og:article:tag" content="api"><meta property="og:image" content="https://www.definit.co.uk/images/logos/kubernetes.svg"><meta name=twitter:card content="summary"><meta name=twitter:site content="@sammcgeown"><meta name=twitter:creator content="@sammcgeown"><meta name=twitter:title content="Lab Guide - Kubernetes and NSX-T Container Network Plugin - Step by Step"><meta name=twitter:description content><meta name=twitter:url content="https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/"><meta name=twitter:domain content="https://www.definit.co.uk"><link rel=canonical href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step/><link rel=apple-touch-icon-precomposed sizes=144x144 href=/touch-icon-144-precomposed.png><link rel=icon href=/images/favicon-16x16.png><meta name=generator content="Hugo 0.84.0"><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><script src=/js/clr-1.0/clr-icons.min.js></script><script src=/js/clr-1.0/custom-elements.min.js></script><link href=/css/clr-1.0/clr-ui-dark.css rel=stylesheet><link href=/css/clr-1.0/clr-icons.min.css rel=stylesheet><link href=/css/definit-clarity.css rel=stylesheet><link href=/css/lightbox.min.css rel=stylesheet></head><body data-ng-app=myapp data-ng-controller=MyController data-ng-mouseleave=MouseLeave($event)><div class=main-container><header class=header-6><div class=branding><a class=navbar-brand-img href=/><img alt src=/images/logos/definit-logo.png>
<span class=title>DefinIT</span></a></div><nav class=header-nav><a class="nav-link nav-text" href=https://www.definit.co.uk/>Home</a>
<a class="nav-link nav-text" href=https://www.definit.co.uk/about/>About</a>
<a class="nav-link nav-text" href=https://www.github.com/sammcgeown>GitHub</a>
<a class="nav-link nav-text" href=https://www.definit.co.uk/index.xml>RSS</a></nav><div class=header-actions><form class=search id=search method=get action=//google.com/search><label for=search_input><input id=search_input type=text name=q placeholder="Search with Google">
<input type=hidden name=as_sitesearch value=https://www.definit.co.uk></label></form></div></header><nav class=subnav><ul class=nav><li class=nav-item><a class=nav-link href=https://www.definit.co.uk/>Home</a></li><li class=nav-item><a class=nav-link href=https://www.definit.co.uk/about/>About</a></li><li class=nav-item><a class=nav-link href=https://www.github.com/sammcgeown>GitHub</a></li><li class=nav-item><a class=nav-link href=https://www.definit.co.uk/index.xml>RSS</a></li></ul></nav><div class=content-container><div class=content-area><h1>LAB GUIDE - KUBERNETES AND NSX-T CONTAINER NETWORK PLUGIN - STEP BY STEP</h1><div class=metas><span class=clr-card-authors><div class=clr-card-authors><img src=/images/SamMcGeown2020.jpg alt class=img-author>Written by <a href=https://www.definit.co.uk/authors/sam-mcgeown/>Sam McGeown</a>
on 12/6/2019
&#183; Read in about 11 min (2322 words)</div><div class=clr-card-authors>Published under <a href=/category/nsx>NSX</a>, <a href=/category/vmware>VMware</a> and <a href=/category/cloud-native>Cloud Native</a></div><div class=clr-card-authors>Tags:
<a class=clr-tags href=https://www.definit.co.uk/tag/nsx>#nsx</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/cnp>#cnp</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/kubernetes>#kubernetes</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/ubuntu>#ubuntu</a>
<a class=clr-tags href=https://www.definit.co.uk/tag/api>#api</a></div></span></div><br clear=all><img src=/images/logos/kubernetes.svg class=clr-post-featured-image><p>I’ve done a fair amount of work learning VMware PKS and NSX-T, but I wanted to
drop down a level and get more familiar with the inner workings for Kubernetes,
as well as explore some of the newer features that are exposed by the NSX
Container Plugin that are not yet in the PKS integrations.</p><p>The NSX-T docs are…not great, I certainly don’t think you can work out the steps
required from the official <a href=https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-FB641321-319D-41DC-9D16-37D6BA0BC0DE.html>NCP installation
guide</a>
without a healthy dollop of background knowledge and familiarity with Kubernetes
and CNI. <a href=https://networkinferno.net/preparing-a-node-for-kubernetes-and-nsx-ncp>Anthony Burke published this
guide</a>
which is great, and I am lucky enough to be able to pick his brains on our
corporate slack.</p><p>So, what follows is a step-by-step guide that is the product of my learning
process - I can’t guarantee it’s perfect, but I’ve tried to write these steps in
a logical order, validate them and add some explanation as I go through. If you
spot a mistake, or an error, please feel free to get in touch (for my learning,
and so I can correct it!)</p><h1 id=preparing-the-nodes>Preparing the Nodes</h1><h2 id=software-versions>Software Versions</h2><table><thead><tr><th><strong>Component</strong></th><th><strong>Version</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>NSX-T</td><td>2.4.1</td><td>Latest at time of writing</td></tr><tr><td>Server OS</td><td>Ubuntu 16.04</td><td>16.04 is the most recent supported by NSX-T NCP</td></tr><tr><td>Docker</td><td>current</td><td></td></tr><tr><td>Kubernetes</td><td>1.13.5-00</td><td>Required for NSX-T NCP</td></tr><tr><td>Open vSwitch</td><td>2.9.1</td><td>Must be the version packaged with NSX-T 2.4</td></tr></tbody></table><p>Be sure to check compatibility requirements for the NSX Container Plug-in
<a href=https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-AD7BA088-2A51-4D5F-BC86-6EE14CE17665.html>https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-AD7BA088-2A51-4D5F-BC86-6EE14CE17665.html</a></p><h2 id=ubuntu-vms>Ubuntu VMs</h2><p>Three Ubuntu 16.04 virtual machines deployed with 2 vCPU and 4GB RAM each. The
VMs have been deployed as default installations, and this guide assumes the
same.</p><p>DNS records have been created for each VM.</p><table><thead><tr><th><strong>Name</strong></th><th><strong>Role</strong></th><th><strong>FQDN</strong></th><th><strong>IP</strong></th></tr></thead><tbody><tr><td>k8s-m01</td><td>Master</td><td>k8s-m01.definit.local</td><td>10.0.0.10</td></tr><tr><td>k8s-w01</td><td>Worker</td><td>k8s-w01.definit.local</td><td>10.0.0.11</td></tr><tr><td>k8s-w02</td><td>Worker</td><td>k8s-w02.definit.local</td><td>10.0.0.12</td></tr></tbody></table><h4 id=network-adapters>Network adapters</h4><p>Each node is configured with three network adapters.</p><table><thead><tr><th><strong>Network</strong></th><th><strong>NIC</strong></th><th><strong>IP Addressing</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>Management</td><td>ens160</td><td>192.168.10.0/24</td><td>VLAN backed network used for management access from the Kubernetes nodes to the NSX Manager</td></tr><tr><td>Kubernetes Access</td><td>ens192</td><td>10.0.0.0/24</td><td>NSX-T segment (logical switch) that’s connected to the tier 1 router (t1-kubernetes) and provides access to Kubernetes nodes. Default route.</td></tr><tr><td>Kubernetes Transport</td><td>ens224</td><td>None</td><td>NSX-T segment (logical switch) that provides a transport network.</td></tr></tbody></table><p>Example <code>/etc/network/interfaces</code> file:</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span>iface lo inet loopback
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>auto lo
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#080;background-color:#0f140f;font-style:italic># management</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span>auto ens160
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>iface ens160 inet static
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span>    address 192.168.10.90
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>    netmask 255.255.255.0
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#080;background-color:#0f140f;font-style:italic># k8s-access</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>auto ens192
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>iface ens192 inet static
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span>    address 10.0.0.10
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>    netmask 255.255.255.0
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span>    gateway 10.0.0.1
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>    dns-nameservers	192.168.10.17
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>    dns-search	definit.local
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#080;background-color:#0f140f;font-style:italic># k8s-transport</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span>auto ens224
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span>iface ens224 inet manual
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span>    up ip link set ens224 up
</code></pre></div><h2 id=install-docker-and-kubernetes>Install Docker and Kubernetes</h2><p>Disable swap (required for kubelet to run), install Docker, and install Kubernetes 1.13.</p><h4 id=master-and-worker-nodes><strong>Master and Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Disable swap</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span>sudo swapoff -a
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Update and upgrade</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span>sudo apt-get update &amp;&amp; sudo apt-get upgrade -y
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#080;background-color:#0f140f;font-style:italic># Install docker</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span>sudo apt-get install -y docker.io apt-transport-https curl
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#080;background-color:#0f140f;font-style:italic># Start and enable docker</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>sudo systemctl start docker.service
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span>sudo systemctl enable docker.service
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#080;background-color:#0f140f;font-style:italic># Add the Kubernetes repository and key</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span>echo <span style=color:#0086d2>&#34;deb  http://apt.kubernetes.io/  kubernetes-xenial  main&#34;</span> | sudo tee -a /etc/apt/sources.list.d/kubernetes.list
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span>curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#080;background-color:#0f140f;font-style:italic># Update package lists</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span>sudo apt-get update
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#080;background-color:#0f140f;font-style:italic># Install kubernetes 1.13 and hold the packages</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span>sudo apt-get install -y <span style=color:#fb660a>kubelet</span>=1.13.5-00 <span style=color:#fb660a>kubeadm</span>=1.13.5-00 <span style=color:#fb660a>kubectl</span>=1.13.5-00
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span>sudo apt-mark hold kubelet kubeadm kubectl
</code></pre></div><p>You should also edit /etc/fstab and comment out the swap line to ensure the swap stays disabled</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#080;background-color:#0f140f;font-style:italic># /etc/fstab: static file system information.</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#080;background-color:#0f140f;font-style:italic>#</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Use &#39;blkid&#39; to print the universally unique identifier for a</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#080;background-color:#0f140f;font-style:italic># device; this may be used with UUID= as a more robust way to name devices</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#080;background-color:#0f140f;font-style:italic># that works even if disks are added and removed. See fstab(5).</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#080;background-color:#0f140f;font-style:italic>#</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#080;background-color:#0f140f;font-style:italic># &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span>/dev/mapper/ubuntu--1604--k8s--vg-root /               ext4    <span style=color:#fb660a>errors</span>=remount-ro <span style=color:#0086f7;font-weight:700>0</span>       <span style=color:#0086f7;font-weight:700>1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#080;background-color:#0f140f;font-style:italic># /boot was on /dev/sda1 during installation</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#fb660a>UUID</span>=0caaf4eb-734a-43f0-b4ef-b7b0a012abfc /boot           ext2    defaults        <span style=color:#0086f7;font-weight:700>0</span>       <span style=color:#0086f7;font-weight:700>2</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#080;background-color:#0f140f;font-style:italic>#/dev/mapper/ubuntu--1604--k8s--vg-swap_1 none            swap    sw              0       0</span>
</code></pre></div><h2 id=install-the-cni-plugin>Install the CNI Plugin</h2><p>Download the NSX Container zip package to the home folder</p><h4 id=master-and-worker-nodes-1><strong>Master and Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Validate apparmor is enables (expected output is &#34;Y&#34;)</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo cat /sys/module/apparmor/parameters/enabled
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Extract the NSX Container package</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>unzip nsx-container-2.4.1.13515827.zip
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#080;background-color:#0f140f;font-style:italic># Install the CNI Plugin</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span>sudo dpkg -i nsx-container-2.4.1.13515827/Kubernetes/ubuntu_amd64/nsx-cni_2.4.1.13515827_amd64.deb
</code></pre></div><h2 id=install-open-vswitch>Install Open vSwitch</h2><p>You must install the Open vSwitch package bundled with the NSX Container plugin</p><h4 id=master-and-worker-nodes-2><strong>Master and Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Install dependencies</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo apt-get install -y dkms libc6-dev make python python-six python-argparse 
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Install OVS</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>sudo dpkg -i nsx-container-2.4.1.13515827/OpenvSwitch/xenial_amd64/openvswitch-datapath-dkms_2.10.2.13185890-1_all.deb nsx-container-2.4.1.13515827/OpenvSwitch/xenial_amd64/openvswitch-common_2.10.2.13185890-1_amd64.deb nsx-container-2.4.1.13515827/OpenvSwitch/xenial_amd64/openvswitch-switch_2.10.2.13185890-1_amd64.deb nsx-container-2.4.1.13515827/OpenvSwitch/xenial_amd64/libopenvswitch_2.10.2.13185890-1_amd64.deb
</code></pre></div><h2 id=configure-open-vswitch>Configure Open vSwitch</h2><p>Open vSwitch should be configured to use the network interface</p><h4 id=master-and-worker-nodes-3><strong>Master and Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Create the OVS Bridge</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo ovs-vsctl add-br br-int
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Assign the k8s-transport interface for overlay traffic</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>sudo ovs-vsctl add-port br-int ens224 -- set Interface ens224 <span style=color:#fb660a>ofport_request</span>=<span style=color:#0086f7;font-weight:700>1</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#080;background-color:#0f140f;font-style:italic># Bring the bridge and overlay interface up</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span>sudo ip link set br-int up
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span>sudo ip link set ens224 up
</code></pre></div><h1 id=configure-nsx-t-resources>Configure NSX-T Resources</h1><p>NSX-T 2.4 introduces a new intent-based policy API, which is reflected in the
changes in the user interface. Unfortunately the NCP does not use the new policy
API, so the objects created for consumption by NCP must be created using the
&ldquo;Advanced Networking and Security&rdquo; tab.</p><p>For all components, collect the object ID for later use.</p><h2 id=overlay-transport-zone>Overlay Transport Zone</h2><p>Create, or use an existing overlay transport zone</p><div class=clr-content-image-wrap><a href=index.images/XGZRmk.png data-lightbox=index.images/XGZRmk.png data-title class=lb><img class=lb src=index.images/XGZRmk.png alt></a><figcaption class=clr-caption></figcaption></div><h2 id=routers>Routers</h2><h3 id=tier-0>Tier 0</h3><p>Deploy and configure a tier 0 router, this will be the point of ingress/egress
to the NSX-T networks. The router must be created in active/standby mode, since
stateful services are required (NAT).</p><h3 id=tier-1>Tier 1</h3><p>Deploy and configure a tier 1 router, this router will provide access to the
Kubernetes cluster via the <em>k8s-access</em> segment created below. The tier 1 router
should be connected to the tier 0 router, and a router port configured for the
<em>k8s-access</em> segment.</p><div class=clr-content-image-wrap><a href=index.images/Qa9NvS.png data-lightbox=index.images/Qa9NvS.png data-title class=lb><img class=lb src=index.images/Qa9NvS.png alt></a><figcaption class=clr-caption></figcaption></div><h2 id=segments>Segments</h2><h3 id=k8s-transport>k8s-transport</h3><p>The switch ports for the kubernetes nodes on the transport need to be tagged so
that the NCP can identify them.</p><table><thead><tr><th><strong>Tag</strong></th><th><strong>Scope</strong></th></tr></thead><tbody><tr><td>&lt;node name></td><td>ncp/node_name</td></tr><tr><td>&lt;kubernetes cluster name></td><td>ncp/cluster</td></tr></tbody></table><h3 id=k8s-access>k8s-access</h3><p>The k8s-access segment will be the API access to the Kubernetes cluster. It
should be created and connected to the a router port on the tier 1 router.</p><h2 id=ip-blocks>IP Blocks</h2><table><thead><tr><th><strong>Name</strong></th><th><strong>CIDR</strong></th><th><strong>Notes</strong></th></tr></thead><tbody><tr><td>k8s-pod-network</td><td>172.16.0.0/16</td><td></td></tr></tbody></table><h2 id=ip-pool-for-snat>IP Pool for SNAT</h2><p>Create an IP pool in NSX Manager that is for allocating IP addresses for
translating Pod IPs and Ingress controllers using SNAT/DNAT rules. These IP
addresses are also referred to as external IPs.</p><table><thead><tr><th><strong>Name</strong></th><th><strong>Range</strong></th><th><strong>CIDR</strong></th></tr></thead><tbody><tr><td>k8s-snat</td><td>10.0.1.1-10.0.1.254</td><td>10.0.1.0/24</td></tr></tbody></table><p> </p><div class=clr-content-image-wrap><a href=index.images/KpA6q2.png data-lightbox=index.images/KpA6q2.png data-title class=lb><img class=lb src=index.images/KpA6q2.png alt></a><figcaption class=clr-caption></figcaption></div><h2 id=firewall>Firewall</h2><p>The NCP plugin creates firewall rules for pod isolation and policy for access
between a “top” and “bottom” marker section. By default, if these marker
sections are not created, all isolation rules will be created at the bottom of
the list, and all access policy sections will be created at the top. If you want
to control the rule positions (why wouldn’t you?!) you need to create some
markers.</p><div class=clr-content-image-wrap><a href=index.images/MGagKG.png data-lightbox=index.images/MGagKG.png data-title class=lb><img class=lb src=index.images/MGagKG.png alt></a><figcaption class=clr-caption></figcaption></div><p>Collect the component IDs to use later in the NCP configuration</p><table><thead><tr><th><strong>Component</strong></th><th><strong>Name</strong></th><th><strong>ID</strong></th></tr></thead><tbody><tr><td>Tier 0 Router</td><td>t0-kubernetes</td><td>b92fbb43-b664-46e9-bd4a-d8d46dac82f8</td></tr><tr><td>Overlay Transport Zone</td><td>tz-overlay</td><td>f99ba556-eafe-4c23-beaf-8df1723a354e</td></tr><tr><td>Pod IP Block</td><td>k8s-pod-network</td><td>ab81892f-eb9a-4248-8606-b26f2293fa83</td></tr><tr><td>External IP Pool</td><td>k8s-snat-ip-pool</td><td>dde463fb-15d9-456f-aa3d-030e24f1b1db</td></tr><tr><td>Top Firewall Marker</td><td>k8s-top</td><td>f887ba4f-d634-44ff-8338-05c4a214cc93</td></tr><tr><td>Bottom Firewall Marker</td><td>k8s-bottom</td><td>820da106-a35c-43c0-bcf0-edaf94004d9e</td></tr></tbody></table><p> </p><h1 id=create-the-kubernetes-cluster>Create the Kubernetes Cluster</h1><h2 id=initialise-the-cluster>Initialise the Cluster</h2><h4 id=master-node><strong>Master Node</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Initialise the cluster using the master node&#39;s k8s-access IP address</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo kubeadm init --apiserver-advertise-address=10.0.0.10
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#080;background-color:#0f140f;font-style:italic># Copy the Kubernetes config to the non-root user</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span>mkdir -p <span style=color:#fb660a>$HOME</span>/.kube
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span>sudo cp -i /etc/kubernetes/admin.conf <span style=color:#fb660a>$HOME</span>/.kube/config
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span>sudo chown <span style=color:#fb660a;font-weight:700>$(</span>id -u<span style=color:#fb660a;font-weight:700>)</span>:<span style=color:#fb660a;font-weight:700>$(</span>id -g<span style=color:#fb660a;font-weight:700>)</span> <span style=color:#fb660a>$HOME</span>/.kube/config
</code></pre></div><h2 id=join-the-cluster-from-the-worker-nodes>Join the Cluster from the worker nodes</h2><p>Grab the join command from the output of the master node init command</p><h4 id=worker-nodes><strong>Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Join each node</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo kubeadm join 10.0.0.10:6443 --token u1kyen.mr7aeihrkkuz597h --discovery-token-ca-cert-hash sha256:f214d9abdadd1752405250bc99c69dee4d51d24d1940b8984948c4bee7c382a3
</code></pre></div><h1 id=configuring-ncp>Configuring NCP</h1><h2 id=load-the-ncp-docker-image>Load the NCP Docker Image</h2><p>Import the NCP docker image to the local repository on each Kubernetes node. The
image will be loaded with a long and ugly name
&ldquo;registry.local/2.4.1.13515827/nsx-ncp-ubuntu”, so to keep the config files
simple and to help with upgrades later, tag the image to create an alias.</p><h4 id=master-and-worker-nodes-4><strong>Master and Worker Nodes</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>sudo docker load -i nsx-container-2.4.1.13515827/Kubernetes/nsx-ncp-ubuntu-2.4.1.13515827.tar
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>sudo docker image tag registry.local/2.4.1.13515827/nsx-ncp-ubuntu nsx-ncp-ubuntu:2.4.1.13515827
</code></pre></div><p>Now you can refer to the image as nsx-ncp-ubuntu:2.4.1.13515827 in the config
files.</p><h2 id=create-a-namespace-roles-service-accounts>Create a namespace, roles, service accounts</h2><p>The NCP pod can run in the <strong>default</strong> or <strong>kube-system</strong> namespaces, however
creating a namespace for pods to run in is considered a best practice and allows
more granular control over access and permissions.</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Create Namespace for NSX resources</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>Namespace<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span></code></pre></div><p>The recommended RBAC policy for the NCP pod is documented under <a href=https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-AC96C51A-052B-403F-9670-67E55C4C9170.html>Security
Considerations in the NSX-T NCP
documentation</a>.
We can modify this policy to create the namespace, service account and role
resources.</p><p>The first <strong>ServiceAccount</strong> we create is called <em>ncp-svc</em> along with two
<strong>ClusterRoles</strong> <em>ncp-cluster-role</em> and <em>ncp-patch-role</em>. The two roles are
assigned to the new <strong>ServiceAccount</strong> using two <strong>ClusterRoleBinding</strong>. As the
name suggests the account is used to run processes in the NCP pod.</p><p>Figuring out these YAML files can be daunting, especially when you’re just
getting started like me. I found the official documentation pretty useful to
understand how Kubernetes service accounts and roles interact - see <a href=https://kubernetes.io/docs/reference/access-authn-authz/service-accounts-admin/>Managing
Service
Accounts</a>.</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Create a ServiceAccount for NCP namespace</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ServiceAccount<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Create ClusterRole for NCP</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-cluster-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>rules</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>apiGroups</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span style=color:#888>   </span>- <span style=color:#0086d2>&#34;&#34;</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span style=color:#888>   </span>- extensions<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span style=color:#888>   </span>- networking.k8s.io<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>resources</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span style=color:#888>     </span>- deployments<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span style=color:#888>     </span>- endpoints<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span style=color:#888>     </span>- pods<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span style=color:#888>     </span>- pods/log<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span style=color:#888>     </span>- networkpolicies<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># Move &#39;nodes&#39; to ncp-patch-role when hyperbus is disabled.</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span style=color:#888>     </span>- nodes<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span style=color:#888>     </span>- replicationcontrollers<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># Remove &#39;secrets&#39; if not using Native Load Balancer.</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span style=color:#888>     </span>- secrets<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>verbs</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span style=color:#888>     </span>- get<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span style=color:#888>     </span>- watch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span style=color:#888>     </span>- list<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Create ClusterRole for NCP to edit resources</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-patch-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>rules</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>apiGroups</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span style=color:#888>   </span>- <span style=color:#0086d2>&#34;&#34;</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span style=color:#888>   </span>- extensions<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>resources</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># NCP needs to annotate the SNAT errors on namespaces</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span style=color:#888>     </span>- namespaces<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span style=color:#888>     </span>- ingresses<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span style=color:#888>     </span>- services<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>verbs</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span style=color:#888>     </span>- get<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span style=color:#888>     </span>- watch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span style=color:#888>     </span>- list<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span style=color:#888>     </span>- update<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span style=color:#888>     </span>- patch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># NCP needs permission to CRUD custom resource nsxerrors</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>apiGroups</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span style=color:#888>   </span><span style=color:#080;background-color:#0f140f;font-style:italic># The api group is specified in custom resource definition for nsxerrors</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span style=color:#888>   </span>- nsx.vmware.com<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>resources</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span style=color:#888>     </span>- nsxerrors<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span style=color:#888>     </span>- nsxnetworkinterfaces<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span style=color:#888>     </span>- nsxlocks<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>verbs</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span style=color:#888>     </span>- create<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span style=color:#888>     </span>- get<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span style=color:#888>     </span>- list<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span style=color:#888>     </span>- patch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span style=color:#888>     </span>- delete<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span style=color:#888>     </span>- watch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span style=color:#888>     </span>- update<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>apiGroups</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span style=color:#888>   </span>- <span style=color:#0086d2>&#34;&#34;</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span style=color:#888>   </span>- extensions<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span style=color:#888>   </span>- nsx.vmware.com<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>resources</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span style=color:#888>     </span>- ingresses/status<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span style=color:#888>     </span>- services/status<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span style=color:#888>     </span>- nsxnetworkinterfaces/status<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>verbs</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span style=color:#888>     </span>- replace<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span style=color:#888>     </span>- update<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span style=color:#888>     </span>- patch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Bind ServiceAccount created for NCP to its ClusterRole</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRoleBinding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-cluster-role-binding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>roleRef</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span style=color:#888> </span><span style=color:#080;background-color:#0f140f;font-style:italic># Comment out the apiGroup while using OpenShift</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>apiGroup</span>:<span style=color:#888> </span>rbac.authorization.k8s.io<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-cluster-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>subjects</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ServiceAccount<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Bind ServiceAccount created for NCP to the patch ClusterRole</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRoleBinding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-patch-role-binding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>roleRef</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>apiGroup</span>:<span style=color:#888> </span>rbac.authorization.k8s.io<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-patch-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>subjects</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ServiceAccount<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>ncp-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span></code></pre></div><p>The second <strong>ServiceAccount</strong> we need to create is called <em>nsx-agent-svc</em>, which
is used to run the NSX Node Agent Pod. We create a <strong>ClusterRole</strong> to assign the
required permissions, and then another <strong>ClusterRoleBinding</strong> to assign the
account to the role.</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Create a ServiceAccount for nsx-node-agent</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ServiceAccount<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-agent-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Create ClusterRole for nsx-node-agent</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-agent-cluster-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>rules</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>apiGroups</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#888>   </span>- <span style=color:#0086d2>&#34;&#34;</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>resources</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#888>     </span>- endpoints<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#888>     </span>- services<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># Uncomment the following resources when hyperbus is disabled</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># - nodes</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#888>     </span><span style=color:#080;background-color:#0f140f;font-style:italic># - pods</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>verbs</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#888>     </span>- get<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#888>     </span>- watch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span style=color:#888>     </span>- list<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Bind ServiceAccount created for nsx-node-agent to its ClusterRole</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRoleBinding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span style=color:#888></span><span style=color:#080;background-color:#0f140f;font-style:italic># Set the apiVersion to rbac.authorization.k8s.io/v1beta1 when k8s &lt; v1.8</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>rbac.authorization.k8s.io/v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-agent-cluster-role-binding<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>roleRef</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>apiGroup</span>:<span style=color:#888> </span>rbac.authorization.k8s.io<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ClusterRole<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span style=color:#888> </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-agent-cluster-role<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>subjects</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span style=color:#888> </span>- <span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ServiceAccount<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-agent-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span style=color:#888>   </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span></code></pre></div><p>Save the namespace, NCP and NSX Agent config as a single YAML file called
nsx-ncp-rbac.yml, and then deploy the new resources using the following command:</p><h4 id=master-node-or-admin-workstation><strong>Master Node or Admin Workstation</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>kubectl apply -f nsx-ncp-rbac.yml
</code></pre></div><h2 id=prepare-the-ncp-config-file>Prepare the NCP config file</h2><p>In order to deploy the NCP we use a YAML config file that’s included in the NSX
Container Plugin zip package. This consists of a
<a href=https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/>ConfigMap</a>
and a
<a href=https://kubernetes.io/docs/concepts/workloads/controllers/deployment/>Deployment</a>.
These specify the configuration data required to run the application (in this
case NCP) and the pod deployment details.</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Copy the ncp-deployment template from the NSX Container Plugin folder</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>cp nsx-container-2.4.1.13515827/Kubernetes/ncp-deployment.yml . 
</code></pre></div><p>Next we need to edit the settings to match our environment - the file below has
all the comments removed for clarity but I suggest reading through them all.</p><ul><li>Be sure to add the <em>namespace</em></li><li><em>cluster</em> must match the value created in the NSX ncp/cluster tags</li><li>I’m using password authentication for NSX in my lab…don’t do this in
production! <a href=https://docs.vmware.com/en/VMware-NSX-T-Data-Center/2.4/com.vmware.nsxt.ncp_kubernetes.doc/GUID-6BB49AC0-2A18-4F1B-819C-4C14890F4EB2.html>Configure TLS
Certificates</a></li><li>All the component IDs below are the ones collected when we created the NSX
components</li><li>Be sure to update the <em>serviceAccountName</em> value with the ServiceAccount
created in the RBAC</li><li>Make sure the <em>image</em> value is updated with the tagged name in the docker
local registry</li></ul><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ConfigMap<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-ncp-config<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>data</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>ncp.ini</span>:<span style=color:#888> </span>|<span style=color:#0086d2>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span style=color:#0086d2>    [DEFAULT]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span style=color:#0086d2>    [coe]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span style=color:#0086d2>    cluster = k8s-01
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span style=color:#0086d2>    nsxlib_loglevel=INFO
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span style=color:#0086d2>    enable_snat = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span style=color:#0086d2>    node_type = HOSTVM
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span style=color:#0086d2>    [ha]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span style=color:#0086d2>    [k8s]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span style=color:#0086d2>    apiserver_host_ip = 10.0.0.10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span style=color:#0086d2>    apiserver_host_port = 6443
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span style=color:#0086d2>    ca_file = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span style=color:#0086d2>    client_token_file = /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span style=color:#0086d2>    [nsx_v3]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span style=color:#0086d2>    nsx_api_managers = nsx-manager.definit.local
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span style=color:#0086d2>    nsx_api_user = admin
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span style=color:#0086d2>    nsx_api_password = VMware1!
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span style=color:#0086d2>    insecure = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span style=color:#0086d2>    top_tier_router = b92fbb43-b664-46e9-bd4a-d8d46dac82f8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span style=color:#0086d2>    overlay_tz = tz-overlay
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span style=color:#0086d2>    subnet_prefix = 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span style=color:#0086d2>    use_native_loadbalancer = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span style=color:#0086d2>    l4_lb_auto_scaling = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span style=color:#0086d2>    default_ingress_class_nsx = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span style=color:#0086d2>    pool_algorithm = &#39;ROUND_ROBIN&#39;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span style=color:#0086d2>    service_size = &#39;SMALL&#39;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span style=color:#0086d2>    l7_persistence = &#39;source_ip&#39;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span style=color:#0086d2>    l4_persistence = &#39;source_ip&#39;
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span style=color:#0086d2>    container_ip_blocks = ab81892f-eb9a-4248-8606-b26f2293fa83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span style=color:#0086d2>    external_ip_pools = dde463fb-15d9-456f-aa3d-030e24f1b1db
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span style=color:#0086d2>    top_firewall_section_marker = f887ba4f-d634-44ff-8338-05c4a214cc93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span style=color:#0086d2>    bottom_firewall_section_marker = 820da106-a35c-43c0-bcf0-edaf94004d9e</span><span style=color:#888>    
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>extensions/v1beta1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>Deployment<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-ncp<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>tier</span>:<span style=color:#888> </span>nsx-networking<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>component</span>:<span style=color:#888> </span>nsx-ncp<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>replicas</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>1</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>template</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>tier</span>:<span style=color:#888> </span>nsx-networking<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>component</span>:<span style=color:#888> </span>nsx-ncp<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>hostNetwork</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>serviceAccountName</span>:<span style=color:#888> </span>ncp-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>containers</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-ncp<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>image</span>:<span style=color:#888> </span>nsx-ncp-ubuntu:2.4.1.13515827<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>imagePullPolicy</span>:<span style=color:#888> </span>IfNotPresent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>env</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">67</span><span style=color:#888>            </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>NCP_NAME<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>valueFrom</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span style=color:#888>                </span><span style=color:#fb660a;font-weight:700>fieldRef</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span style=color:#888>                  </span><span style=color:#fb660a;font-weight:700>fieldPath</span>:<span style=color:#888> </span>metadata.name<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span style=color:#888>            </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>NCP_NAMESPACE<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>valueFrom</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span style=color:#888>                </span><span style=color:#fb660a;font-weight:700>fieldRef</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span style=color:#888>                  </span><span style=color:#fb660a;font-weight:700>fieldPath</span>:<span style=color:#888> </span>metadata.namespace<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>livenessProbe</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>exec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span style=color:#888>                </span>- /bin/sh<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span style=color:#888>                </span>- -c<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span style=color:#888>                </span>- timeout 5 check_pod_liveness nsx-ncp<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>initialDelaySeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>timeoutSeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>periodSeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>10</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>failureThreshold</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>volumeMounts</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>config-volume<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">87</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/etc/nsx-ujo/ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">88</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>subPath</span>:<span style=color:#888> </span>ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">89</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>readOnly</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">90</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>volumes</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">91</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>config-volume<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">92</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>configMap</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">93</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-ncp-config<span style=color:#888>
</span></code></pre></div><h2 id=prepare-the-nsx-node-agent-config-file>Prepare the NSX Node Agent config file</h2><p>For the NSX Node Agent, we also need to prepare a YAML config file consisting of
a <strong>ConfigMap</strong> and <strong>Deployment</strong>.</p><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span style=color:#080;background-color:#0f140f;font-style:italic># Copy the NSX Node Agent YAML config</span>
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>cp nsx-container-2.4.1.13515827/Kubernetes/ubuntu_amd64/nsx-node-agent-ds.yml .
</code></pre></div><p>Again I’ve removed the comments to make it clearer but they’re useful to read.</p><ul><li>Be sure to add the <em>namespace</em></li><li><em>cluster</em> must match the value created in the NSX ncp/cluster tags</li><li><em>ovs_bridge</em> must match the bridge created earlier</li><li>Be sure to update the <em>serviceAccountName</em> value with the ServiceAccount created in the RBAC</li><li>Make sure the <em>image</em> value is updated with the tagged name in the docker local registry</li></ul><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1</span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>ConfigMap<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-node-agent-config<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>data</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>ncp.ini</span>:<span style=color:#888> </span>|<span style=color:#0086d2>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10</span><span style=color:#0086d2>    [DEFAULT]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11</span><span style=color:#0086d2>    [coe]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12</span><span style=color:#0086d2>    cluster = k8s-01
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13</span><span style=color:#0086d2>    nsxlib_loglevel=INFO
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14</span><span style=color:#0086d2>    enable_snat = True
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15</span><span style=color:#0086d2>    node_type = HOSTVM
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16</span><span style=color:#0086d2>    [ha]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17</span><span style=color:#0086d2>    [k8s]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18</span><span style=color:#0086d2>    apiserver_host_ip = 10.0.0.10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19</span><span style=color:#0086d2>    apiserver_host_port = 6443
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20</span><span style=color:#0086d2>    ca_file = /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21</span><span style=color:#0086d2>    client_token_file = /var/run/secrets/kubernetes.io/serviceaccount/token
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22</span><span style=color:#0086d2>    [nsx_node_agent]
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23</span><span style=color:#0086d2>    ovs_bridge = br-int
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24</span><span style=color:#0086d2>    [nsx_kube_proxy]</span><span style=color:#888>    
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25</span><span style=color:#888></span>---<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>apiVersion</span>:<span style=color:#888> </span>extensions/v1beta1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>kind</span>:<span style=color:#888> </span>DaemonSet<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-node-agent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>namespace</span>:<span style=color:#888> </span>nsx-system<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>tier</span>:<span style=color:#888> </span>nsx-networking<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>component</span>:<span style=color:#888> </span>nsx-node-agent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35</span><span style=color:#888></span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>updateStrategy</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>type</span>:<span style=color:#888> </span>RollingUpdate<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38</span><span style=color:#888>  </span><span style=color:#fb660a;font-weight:700>template</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>metadata</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>annotations</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>container.apparmor.security.beta.kubernetes.io/nsx-node-agent</span>:<span style=color:#888> </span>localhost/node-agent-apparmor<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>labels</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>tier</span>:<span style=color:#888> </span>nsx-networking<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>component</span>:<span style=color:#888> </span>nsx-node-agent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45</span><span style=color:#888>        </span><span style=color:#fb660a;font-weight:700>version</span>:<span style=color:#888> </span>v1<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46</span><span style=color:#888>    </span><span style=color:#fb660a;font-weight:700>spec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>hostNetwork</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>serviceAccountName</span>:<span style=color:#888> </span>nsx-agent-svc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>containers</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-node-agent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>image</span>:<span style=color:#888> </span>nsx-ncp-ubuntu:2.4.1.13515827<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>imagePullPolicy</span>:<span style=color:#888> </span>IfNotPresent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888> </span>[<span style=color:#0086d2>&#34;start_node_agent&#34;</span>]<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>livenessProbe</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>exec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57</span><span style=color:#888>                </span>- /bin/sh<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58</span><span style=color:#888>                </span>- -c<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59</span><span style=color:#888>                </span>- timeout 5 check_pod_liveness nsx-node-agent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>initialDelaySeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>timeoutSeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>periodSeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>10</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>failureThreshold</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>securityContext</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>capabilities</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>add</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67</span><span style=color:#888>                </span>- NET_ADMIN<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68</span><span style=color:#888>                </span>- SYS_ADMIN<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69</span><span style=color:#888>                </span>- SYS_PTRACE<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70</span><span style=color:#888>                </span>- DAC_READ_SEARCH<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>volumeMounts</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>config-volume<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/etc/nsx-ujo/ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>subPath</span>:<span style=color:#888> </span>ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>readOnly</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>openvswitch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/var/run/openvswitch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>cni-sock<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/var/run/nsx-ujo<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>netns<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/var/run/netns<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>proc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/host/proc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>readOnly</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-kube-proxy<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>image</span>:<span style=color:#888> </span>nsx-ncp-ubuntu:2.4.1.13515827<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>imagePullPolicy</span>:<span style=color:#888> </span>IfNotPresent<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888> </span>[<span style=color:#0086d2>&#34;start_kube_proxy&#34;</span>]<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>livenessProbe</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>exec</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>command</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92</span><span style=color:#888>                </span>- /bin/sh<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93</span><span style=color:#888>                </span>- -c<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94</span><span style=color:#888>                </span>- timeout 5 check_pod_liveness nsx-kube-proxy<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>initialDelaySeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>periodSeconds</span>:<span style=color:#888> </span><span style=color:#0086f7;font-weight:700>5</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>securityContext</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>capabilities</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99</span><span style=color:#888>              </span><span style=color:#fb660a;font-weight:700>add</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100</span><span style=color:#888>                </span>- NET_ADMIN<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101</span><span style=color:#888>                </span>- SYS_ADMIN<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102</span><span style=color:#888>                </span>- SYS_PTRACE<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103</span><span style=color:#888>                </span>- DAC_READ_SEARCH<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>volumeMounts</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>config-volume<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/etc/nsx-ujo/ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>subPath</span>:<span style=color:#888> </span>ncp.ini<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>readOnly</span>:<span style=color:#888> </span><span style=color:#fb660a;font-weight:700>true</span><span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span style=color:#888>          </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>openvswitch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>mountPath</span>:<span style=color:#888> </span>/var/run/openvswitch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span style=color:#888>      </span><span style=color:#fb660a;font-weight:700>volumes</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>config-volume<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>configMap</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>nsx-node-agent-config<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>cni-sock<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>hostPath</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>path</span>:<span style=color:#888> </span>/var/run/nsx-ujo<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>netns<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>hostPath</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>path</span>:<span style=color:#888> </span>/var/run/netns<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>proc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>hostPath</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>path</span>:<span style=color:#888> </span>/proc<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span style=color:#888>        </span>- <span style=color:#fb660a;font-weight:700>name</span>:<span style=color:#888> </span>openvswitch<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span style=color:#888>          </span><span style=color:#fb660a;font-weight:700>hostPath</span>:<span style=color:#888>
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">126</span><span style=color:#888>            </span><span style=color:#fb660a;font-weight:700>path</span>:<span style=color:#888> </span>/var/run/openvswitch<span style=color:#888>
</span></code></pre></div><h2 id=finallydeploy-ncp-and-nsx-node-agent>Finally…deploy NCP and NSX Node Agent!</h2><p>After what seems like a long journey, we’re finally at the point where we can
deploy the NCP and Node Agent.</p><h4 id=master-node-or-admin-workstation-1><strong>Master Node or Admin Workstation</strong></h4><div class=highlight><pre style=color:#fff;background-color:#111;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span>kubectl apply -f ncp-deployment.yml
<span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span>kubectl apply -f nsx-node-agent-ds.yml
</code></pre></div><p>All being well, we should now have NCP configured and ready to go, switch to the
nsx-system namespace (check out <a href=https://github.com/ahmetb/kubectx>kubens</a> for
this!) and view the resources using <code>kubectl get &lt;resource></code> and <code>kubectl describe &lt;resource> &lt;resource name></code></p><p>NCP will create components for each Kubernetes namespace, these can be viewed
through the Advanced Networking and Security Tab.</p><h4 id=routers-1>Routers</h4><div class=clr-content-image-wrap><a href=index.images/Gs6Jut.png data-lightbox=index.images/Gs6Jut.png data-title class=lb><img class=lb src=index.images/Gs6Jut.png alt></a><figcaption class=clr-caption></figcaption></div><h4 id=switches>Switches</h4><div class=clr-content-image-wrap><a href=index.images/9xMcCi.png data-lightbox=index.images/9xMcCi.png data-title class=lb><img class=lb src=index.images/9xMcCi.png alt></a><figcaption class=clr-caption></figcaption></div><h4 id=load-balancer>Load Balancer</h4><div class=clr-content-image-wrap><a href=index.images/MBD3UW.png data-lightbox=index.images/MBD3UW.png data-title class=lb><img class=lb src=index.images/MBD3UW.png alt></a><figcaption class=clr-caption></figcaption></div><h4 id=firewall-rules>Firewall Rules</h4><div class=clr-content-image-wrap><a href=index.images/rtQkFK.png data-lightbox=index.images/rtQkFK.png data-title class=lb><img class=lb src=index.images/rtQkFK.png alt></a><figcaption class=clr-caption></figcaption></div><h6>Share this post</h6><span class=share-box><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" onclick="return window.open(this.href,'mywin','left=20,top=20,width=500,height=500,toolbar=1,resizable=0'),!1"><i class="fa fa-facebook-official"></i></a>
<a href="https://twitter.com/intent/tweet?text=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" onclick="return window.open(this.href,'mywin','left=20,top=20,width=500,height=500,toolbar=1,resizable=0'),!1"><i class="fa fa-twitter"></i></a>
<a href="https://plus.google.com/share?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" onclick="return window.open(this.href,'mywin','left=20,top=20,width=500,height=500,toolbar=1,resizable=0'),!1"><i class="fa fa-google-plus"></i></a>
<a href="http://www.reddit.com/submit?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" onclick="return window.open(this.href,'mywin','left=20,top=20,width=900,height=500,toolbar=1,resizable=0'),!1"><i class="fa fa-reddit"></i></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f&title=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step" onclick="return window.open(this.href,'mywin','left=20,top=20,width=500,height=500,toolbar=1,resizable=0'),!1"><i class="fa fa-linkedin"></i></a>
<a href="mailto:?subject=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&body=Check out this site https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" data-proofer-ignore><i class="fa fa-envelope"></i></a></span>
<a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.tumblr.com/widgets/share/tool?posttype=link&title=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&caption=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&content=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f&canonicalUrl=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f&shareSource=tumblr_share_button" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--tumblr resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13.5.5v5h5v4h-5V15c0 5 3.5 4.4 6 2.8v4.4c-6.7 3.2-12 0-12-4.2V9.5h-3V6.7c1-.3 2.2-.7 3-1.3.5-.5 1-1.2 1.4-2 .3-.7.6-1.7.7-3h3.8z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f&title=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&summary=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&source=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6.0 2.5 1 2.6 2.5.0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f&resubmit=true&title=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&body=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_self rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="whatsapp://send?text=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step%20https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3.0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7.0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1.0-5.2 4.2-9.4 9.4-9.4 2.5.0 4.9 1 6.7 2.8s2.8 4.2 2.8 6.7c-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2s0-.5.1-.6.3-.3.4-.5c.2-.1.3-.3.4-.5s0-.4.0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://telegram.me/share/url?text=Lab%20Guide%20-%20Kubernetes%20and%20NSX-T%20Container%20Network%20Plugin%20-%20Step%20by%20Step&url=https%3a%2f%2fwww.definit.co.uk%2f2019%2f06%2flab-guide-kubernetes-and-nsx-t-container-network-plugin-step-by-step%2f" target=_blank rel=noopener aria-label><div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.707 8.475C.275 8.64.0 9.508.0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102.0 001.75.527l2.96-2.41a.405.405.0 01.494-.013l5.34 3.87a1.1 1.1.0 001.046.135 1.1 1.1.0 00.682-.803l3.91-18.795A1.102 1.102.0 0022.5.075L.706 8.475z"/></svg></div></div></a><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var a=document.createElement('script');a.async=!0,a.type='text/javascript',a.src='//definit.disqus.com/embed.js',(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(a)})()</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><div class="clarity-prev-next col-xs-12 col-sm-12 col-md-12 col-lg-12"><nav class=clarity-page-prev-next><div class=clr-nav-previous><a href=https://www.definit.co.uk/2019/05/unable-to-configure-route-redistribution-with-cross-vcenter-nsx-6.4/ title="Unable to configure route redistribution with cross-vCenter NSX 6.4" class="btn btn-sm btn-outline">Previous</a></div><div class=clr-nav-next><a href=https://www.definit.co.uk/2019/06/lab-guide-kubernetes-and-storage-with-the-vsphere-cloud-provider-step-by-step/ title="Lab Guide - Kubernetes and Storage with the vSphere Cloud Provider - Step by Step" class="btn btn-sm btn-outline">Next</a></div></nav></div></div><div class=content-area></div><nav class="sidenav clr-col-12 clr-col-sm-12 clr-col-md-12 clr-col-lg-6 clr-col-xl-6"><section class=sidenav-content><section class="nav-group collapsible"><input id=Categories type=checkbox>
<label for=Categories>Categories</label><ul class=nav-list><li><a href=/category/automation class=nav-link>AUTOMATION <span class="badge badge-1">7</span></a></li><li><a href=/category/career class=nav-link>CAREER <span class="badge badge-1">22</span></a></li><li><a href=/category/certification class=nav-link>CERTIFICATION <span class="badge badge-1">2</span></a></li><li><a href=/category/cloud class=nav-link>CLOUD <span class="badge badge-1">8</span></a></li><li><a href=/category/cloud-native class=nav-link>CLOUD-NATIVE <span class="badge badge-1">14</span></a></li><li><a href=/category/community class=nav-link>COMMUNITY <span class="badge badge-1">41</span></a></li><li><a href=/category/development class=nav-link>DEVELOPMENT <span class="badge badge-1">3</span></a></li><li><a href=/category/log-insight class=nav-link>LOG-INSIGHT <span class="badge badge-1">2</span></a></li><li><a href=/category/microsoft class=nav-link>MICROSOFT <span class="badge badge-1">60</span></a></li><li><a href=/category/networking class=nav-link>NETWORKING <span class="badge badge-1">34</span></a></li><li><a href=/category/nsx class=nav-link>NSX <span class="badge badge-1">26</span></a></li><li><a href=/category/powercli class=nav-link>POWERCLI <span class="badge badge-1">4</span></a></li><li><a href=/category/storage class=nav-link>STORAGE <span class="badge badge-1">6</span></a></li><li><a href=/category/vcf class=nav-link>VCF <span class="badge badge-1">1</span></a></li><li><a href=/category/vcloud-director class=nav-link>VCLOUD-DIRECTOR <span class="badge badge-1">5</span></a></li><li><a href=/category/vmware class=nav-link>VMWARE <span class="badge badge-1">204</span></a></li><li><a href=/category/vmware-cloud-foundation class=nav-link>VMWARE-CLOUD-FOUNDATION <span class="badge badge-1">1</span></a></li><li><a href=/category/vmworld class=nav-link>VMWORLD <span class="badge badge-1">12</span></a></li><li><a href=/category/vrealize-automation class=nav-link>VREALIZE-AUTOMATION <span class="badge badge-1">43</span></a></li><li><a href=/category/vrealize-operations class=nav-link>VREALIZE-OPERATIONS <span class="badge badge-1">72</span></a></li><li><a href=/category/vrealize-orchestrator class=nav-link>VREALIZE-ORCHESTRATOR <span class="badge badge-1">28</span></a></li><li><a href=/category/vsan class=nav-link>VSAN <span class="badge badge-1">4</span></a></li><li><a href=/category/vsphere class=nav-link>VSPHERE <span class="badge badge-1">56</span></a></li><li><a href=/category/webinar class=nav-link>WEBINAR <span class="badge badge-1">17</span></a></li></ul></section><section class="nav-group collapsible"><input id=Tags type=checkbox>
<label for=Tags>Tags (Top 10)</label><ul class=nav-list><li><a href=/tag/vrops class=nav-link>VROPS <span class="badge badge-1">68</span></a></li><li><a href=/tag/vmware class=nav-link>VMWARE <span class="badge badge-1">51</span></a></li><li><a href=/tag/windows class=nav-link>WINDOWS <span class="badge badge-1">38</span></a></li><li><a href=/tag/automation class=nav-link>AUTOMATION <span class="badge badge-1">35</span></a></li><li><a href=/tag/esx-and-esxi class=nav-link>ESX-AND-ESXI <span class="badge badge-1">33</span></a></li><li><a href=/tag/vcenter-server class=nav-link>VCENTER-SERVER <span class="badge badge-1">33</span></a></li><li><a href=/tag/nsx class=nav-link>NSX <span class="badge badge-1">31</span></a></li><li><a href=/tag/vmworld class=nav-link>VMWORLD <span class="badge badge-1">30</span></a></li><li><a href=/tag/vra class=nav-link>VRA <span class="badge badge-1">28</span></a></li><li><a href=/tag/webinar class=nav-link>WEBINAR <span class="badge badge-1">26</span></a></li></section><section class=nav-group><label for=Sponsors>Sponsors</label><ul class=nav-list></ul></section></section></nav></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-4368767-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-4368767-1')</script><script src=/js/lightbox-plus-jquery.min.js></script></div></body></html>